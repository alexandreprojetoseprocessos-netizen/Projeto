generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum OrganizationStatus {
  ACTIVE
  DEACTIVATED
  SOFT_DELETED
}

model Organization {
  id          String                   @id @default(uuid())
  name        String
  slug        String                   @unique
  domain      String?
  plan        OrganizationPlan         @default(FREE)
  timezone    String                   @default("America/Sao_Paulo")
  createdAt   DateTime                 @default(now())
  updatedAt   DateTime                 @updatedAt
  isActive    Boolean                  @default(true)
  status      OrganizationStatus       @default(ACTIVE)
  deletedAt   DateTime?
  auditLogs   AuditLog[]
  memberships OrganizationMembership[]
  projects    Project[]
  templates   ProjectTemplate[]
  tags        Tag[]
}

model User {
  id                  String                   @id @default(uuid())
  email               String                   @unique
  fullName            String
  passwordHash        String
  locale              String                   @default("pt-BR")
  timezone            String                   @default("America/Sao_Paulo")
  avatarUrl           String?
  active              Boolean                  @default(true)
  twoFactorEnabled    Boolean                  @default(false)
  twoFactorSecret     String?
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
  attachments         Attachment[]
  auditLogs           AuditLog[]
  comments            Comment[]
  notifications       Notification[]
  memberships         OrganizationMembership[]
  managedProjects     Project[]                @relation("ProjectManager")
  projectMembers      ProjectMember[]
  risksOwned          Risk[]                   @relation("RiskOwner")
  approvedTimeEntries TimeEntry[]              @relation("TimeEntryApprover")
  timeEntries         TimeEntry[]
  ownedNodes          WbsNode[]                @relation("NodeOwner")
  subscriptions       Subscription[]
}

model OrganizationMembership {
  id             String         @id @default(uuid())
  organizationId String
  userId         String
  role           MembershipRole @default(MEMBER)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  responsibleNodes WbsNode[]    @relation("ResponsibleMembership")

  @@unique([organizationId, userId])
}

model Project {
  id               String            @id @default(uuid())
  organizationId   String
  managerId        String?
  name             String
  code             String?
  clientName       String?
  description      String?
  status           ProjectStatus     @default(PLANNED)
  startDate        DateTime?
  endDate          DateTime?
  budgetPlanned    Decimal?          @db.Decimal(14, 2)
  budgetActual     Decimal?          @db.Decimal(14, 2)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  archivedAt       DateTime?
  repositoryUrl    String?
  attachments      Attachment[]
  audits           AuditLog[]
  boardColumns     BoardColumn[]
  comments         Comment[]
  costs            Cost[]
  fieldDefinitions FieldDefinition[]
  milestones       Milestone[]
  notifications    Notification[]
  manager          User?             @relation("ProjectManager", fields: [managerId], references: [id])
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members          ProjectMember[]
  risks            Risk[]
  timeEntries      TimeEntry[]
  wbsNodes         WbsNode[]
  serviceCatalogs  ServiceCatalog[]
}

model ProjectTemplate {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  type           String
  clientName     String?
  repositoryUrl  String?
  budget         Decimal?     @db.Decimal(14, 2)
  columns        Json
  wbs            Json
  customFields   Json
  createdAt      DateTime?    @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime?    @default(now()) @updatedAt @db.Timestamptz(6)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
}

model ProjectMember {
  id             String      @id @default(uuid())
  projectId      String
  userId         String
  role           ProjectRole @default(CONTRIBUTOR)
  capacityWeekly Int         @default(40)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  project        Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
}

model Milestone {
  id          String          @id @default(uuid())
  projectId   String
  name        String
  description String?
  dueDate     DateTime
  status      MilestoneStatus @default(PLANNED)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model WbsNode {
  id                        String          @id @default(uuid())
  projectId                 String
  parentId                  String?
  level                     Int             @default(0)
  type                      WbsNodeType     @default(TASK)
  order                     Int             @default(0)
  title                     String
  description               String?
  status                    TaskStatus      @default(BACKLOG)
  priority                  TaskPriority    @default(MEDIUM)
  ownerId                   String?
  startDate                 DateTime?
  endDate                   DateTime?
  estimateHours             Decimal?        @db.Decimal(10, 2)
  actualHours               Decimal?        @db.Decimal(10, 2)
  progress                  Float?          @default(0)
  epicId                    String?
  boardColumnId             String?
  responsibleMembershipId   String?
  createdAt                 DateTime        @default(now())
  updatedAt                 DateTime        @updatedAt
  deletedAt                 DateTime?
  sortOrder                 Int             @default(0)
  wbsCode                   String?
  attachments               Attachment[]
  comments                  Comment[]
  wbsComments               WbsComment[]
  dependenciesAsPredecessor Dependency[]    @relation("Predecessor")
  dependenciesAsSuccessor   Dependency[]    @relation("Successor")
  tags                      TagAssignment[]
  taskDetail                TaskDetail?
  timeEntries               TimeEntry[]
  boardColumn               BoardColumn?    @relation(fields: [boardColumnId], references: [id])
  epic                      WbsNode?        @relation("Epic", fields: [epicId], references: [id])
  epicChildren              WbsNode[]       @relation("Epic")
  owner                     User?           @relation("NodeOwner", fields: [ownerId], references: [id])
  responsibleMembership     OrganizationMembership? @relation("ResponsibleMembership", fields: [responsibleMembershipId], references: [id])
  serviceCatalogId          String?
  serviceCatalog            ServiceCatalog? @relation(fields: [serviceCatalogId], references: [id])
  serviceMultiplier         Float?
  serviceHours              Float?
  parent                    WbsNode?        @relation("WbsParent", fields: [parentId], references: [id], onDelete: Cascade)
  children                  WbsNode[]       @relation("WbsParent")
  project                   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ServiceCatalog {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  name        String
  description String?
  hoursBase   Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  wbsNodes    WbsNode[]
}


model WbsComment {
  id         String   @id @default(uuid())
  wbsNode    WbsNode  @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)
  wbsNodeId  String

  authorId   String?
  authorName String?
  message    String

  createdAt  DateTime @default(now())

  @@index([wbsNodeId])
}

model TaskDetail {
  wbsNodeId     String    @id
  taskType      String?
  storyPoints   Int?
  checklist     Json?
  customFields  Json?
  slaDate       DateTime?
  blockedReason String?
  wbsNode       WbsNode   @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)
}

model Dependency {
  id            String         @id @default(uuid())
  predecessorId String
  successorId   String
  type          DependencyType @default(FS)
  lagDays       Int            @default(0)
  predecessor   WbsNode        @relation("Predecessor", fields: [predecessorId], references: [id], onDelete: Cascade)
  successor     WbsNode        @relation("Successor", fields: [successorId], references: [id], onDelete: Cascade)

  @@unique([predecessorId, successorId])
}

model Comment {
  id          String            @id @default(uuid())
  projectId   String
  targetType  CommentTargetType @default(PROJECT)
  wbsNodeId   String?
  authorId    String
  body        String
  mentions    String[]
  createdAt   DateTime          @default(now())
  attachments Attachment[]
  author      User              @relation(fields: [authorId], references: [id], onDelete: Cascade)
  project     Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  wbsNode     WbsNode?          @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)
}

model Attachment {
  id           String               @id @default(uuid())
  projectId    String
  targetType   AttachmentTargetType @default(PROJECT)
  wbsNodeId    String?
  commentId    String?
  uploadedById String
  fileKey      String
  fileName     String
  fileSize     Int
  version      Int                  @default(1)
  category     String?
  createdAt    DateTime             @default(now())
  comment      Comment?             @relation(fields: [commentId], references: [id], onDelete: Cascade)
  project      Project              @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy   User                 @relation(fields: [uploadedById], references: [id])
  wbsNode      WbsNode?             @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)
}

model TimeEntry {
  id           String    @id @default(uuid())
  projectId    String
  wbsNodeId    String?
  userId       String
  entryDate    DateTime
  hours        Decimal   @db.Decimal(8, 2)
  description  String?
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime  @default(now())
  approvedBy   User?     @relation("TimeEntryApprover", fields: [approvedById], references: [id])
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  wbsNode      WbsNode?  @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)
}

model Risk {
  id          String          @id @default(uuid())
  projectId   String
  title       String
  severity    RiskSeverity    @default(MEDIUM)
  probability RiskProbability @default(MEDIUM)
  impact      String?
  status      RiskStatus      @default(OPEN)
  ownerId     String?
  mitigation  String?
  dueDate     DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  owner       User?           @relation("RiskOwner", fields: [ownerId], references: [id])
  project     Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Cost {
  id           String   @id @default(uuid())
  projectId    String
  category     String
  plannedValue Decimal  @db.Decimal(14, 2)
  actualValue  Decimal? @db.Decimal(14, 2)
  occurredAt   DateTime
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Tag {
  id             String          @id @default(uuid())
  organizationId String
  name           String
  color          String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignments    TagAssignment[]

  @@unique([organizationId, name])
}

model TagAssignment {
  id        String   @id @default(uuid())
  tagId     String
  wbsNodeId String
  createdAt DateTime @default(now())
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  wbsNode   WbsNode  @relation(fields: [wbsNodeId], references: [id], onDelete: Cascade)

  @@unique([tagId, wbsNodeId])
}

model BoardColumn {
  id        String      @id @default(uuid())
  projectId String
  label     String
  order     Int
  wipLimit  Int?
  status    TaskStatus?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks     WbsNode[]
}

model FieldDefinition {
  id         String   @id @default(uuid())
  projectId  String
  name       String
  type       String
  required   Boolean  @default(false)
  visibility String?
  options    Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id             String        @id @default(uuid())
  organizationId String?
  projectId      String?
  actorId        String?
  action         String
  entity         String
  entityId       String
  diff           Json
  createdAt      DateTime      @default(now())
  actor          User?         @relation(fields: [actorId], references: [id])
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project        Project?      @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String              @id @default(uuid())
  userId    String
  projectId String?
  channel   NotificationChannel @default(EMAIL)
  template  String
  payload   Json
  read      Boolean             @default(false)
  readAt    DateTime?
  createdAt DateTime            @default(now())
  project   Project?            @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Product {
  id            String         @id @default(cuid())
  code          String         @unique
  name          String
  description   String?
  priceCents    Int
  billingPeriod String
  active        Boolean        @default(true)

  subscriptions Subscription[]
}

model Subscription {
  id              String              @id @default(cuid())
  userId          String
  productId       String
  status          SubscriptionStatus  @default(ACTIVE)
  startedAt       DateTime            @default(now())
  expiresAt       DateTime?
  paymentMethod   String?
  paymentProvider String?
  providerRef     String?

  user    User    @relation(fields: [userId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

enum OrganizationPlan {
  FREE
  TEAM
  ENTERPRISE
}

enum MembershipRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum ProjectStatus {
  PLANNED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  CANCELED
}

enum ProjectRole {
  MANAGER
  CONTRIBUTOR
  APPROVER
  VIEWER
}

enum MilestoneStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  LATE
  CANCELED
}

enum WbsNodeType {
  PHASE
  DELIVERABLE
  TASK
  SUBTASK
}

enum TaskStatus {
  BACKLOG
  TODO
  IN_PROGRESS
  REVIEW
  DELAYED
  RISK
  BLOCKED
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum DependencyType {
  FS
  SS
  FF
  SF
}

enum CommentTargetType {
  PROJECT
  WBS_NODE
}

enum AttachmentTargetType {
  PROJECT
  WBS_NODE
  COMMENT
}

enum NotificationChannel {
  EMAIL
  PUSH
  SLACK
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
}

enum RiskStatus {
  OPEN
  MITIGATING
  CLOSED
}

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskProbability {
  LOW
  MEDIUM
  HIGH
}
